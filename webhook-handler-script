
REPO=$1
echo "Webhook for $REPO"    
DIR=$(basename $REPO) 

mkdir -p ./repos
LOCAL_GIT=./repos/$DIR 
if test -d $LOCAL_GIT; then 
    echo "Update repo $REPO"
    (cd $LOCAL_GIT; git pull  )  
else       
    echo "First clone of repo $REPO"
    (cd ./repos; git clone $REPO  )    
fi   
if test -d $LOCAL_GIT; then 
    echo "Fail $REPO to process"  
else       
    echo "$REPO ok" 
fi 
 
echo "Check Pipelines" 
PUSH_HANDLER=.tekton/docker-push.yaml 
if test -f ./repos/$DIR/$PUSH_HANDLER; then   
    echo "Running Push pipeline in $PUSH_HANDLER"
    cd ./repos/$DIR  
    PRUN=$(mktemp)
    tkn-pac  resolve -f $PUSH_HANDLER | tee $PRUN  | oc create -f -
    echo "Image Location: " $(yq '.spec.params[] | select(.name == "output-image").value'  $PRUN) 
else 
    echo "$DIR has no tekton handler skipping"  
fi  
 
